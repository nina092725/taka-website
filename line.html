<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>好きなエンタメ</title>
    <link rel="stylesheet" href="banana-slip.css">
    <style>
           body{font-family:'Banana Slip', 'Rounded Mplus 1c', Arial, sans-serif;background:#abced8;margin:0;padding:0;color:#333}
        main{margin-top:28px; max-width:900px; margin-left:auto; margin-right:auto;padding:18px}
        h1.page-title{font-family:'Banana Slip';text-align:center;color:#660033;margin:8px 0 18px;font-size:2rem}
    </style>
</head>
<body>
    <main>
        <h1 class="page-title">好きなエンタメ</h1>
                        <!-- Google スプレッドシートから読み込むお気に入りリスト -->
                        <div style="margin-top:0; max-width:900px; margin-left:auto; margin-right:auto;">
                <div id="sheetContainer">
                    <h3 style="font-family:'Banana Slip'; color:#660033; text-align:center; font-size:1.6rem;">ラジオ</h3>
                    <div id="sheetRadio" style="background:#fffbe7;border-radius:12px;padding:12px;box-shadow:0 4px 12px #66003322;margin-bottom:14px;">
                        <div id="sheetLoadingRadio" style="text-align:center;color:#666;">読み込み中…</div>
                        <ul id="sheetRadioList" style="list-style:disc;padding-left:20px;margin:8px 0;display:flex;flex-direction:column;gap:6px;"></ul>
                    </div>
                    <h3 style="font-family:'Banana Slip'; color:#660033; text-align:center; font-size:1.6rem;">映画・ドラマ</h3>
                    <div id="sheetWorks" style="background:#fffbe7;border-radius:12px;padding:12px;box-shadow:0 4px 12px #66003322;">
                        <div id="sheetLoadingWorks" style="text-align:center;color:#666;display:none;">読み込み中…</div>
                        <ul id="sheetWorksList" style="list-style:disc;padding-left:20px;margin:8px 0;display:flex;flex-direction:column;gap:6px;"></ul>
                    </div>
                </div>
            </div>

            <script>
                // Google スプレッドシートからシート名ごとに取得して表示する
                const sheetId = '17DDnw6-GUBoSaaE9DOB8qWZcNkRuhfYN_L1m9cksUao';

                function fetchSheetByName(name, onSuccess, onError) {
                    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`;
                    fetch(url).then(r => r.text()).then(text => {
                        const jsonText = text.replace(/^\s*\/\*.*?\*\/\s*google\.visualization\.Query\.setResponse\(/, '').replace(/\);\s*$/, '');
                        const data = JSON.parse(jsonText);
                        onSuccess && onSuccess(data);
                    }).catch(err => {
                        console.error('sheet fetch error', err);
                        onError && onError(err);
                    });
                }

                // ラジオシートの描画（曜日順でソート）
                function renderRadioData(data) {
                    const loading = document.getElementById('sheetLoadingRadio');
                    const list = document.getElementById('sheetRadioList');
                    try {
                        const rows = (data.table && data.table.rows) || [];
                        loading.style.display = 'none';
                        list.innerHTML = '';
                        const items = rows.map(r => r.c.map(c => c ? c.v : ''));
                        // 想定: [タイトル, 曜日, ...]
                        const weekdayOrder = ['月曜日','火曜日','水曜日','木曜日','金曜日','土曜日','日曜日'];
                        function weekdayIndex(dayStr) {
                            if (!dayStr) return 999;
                            for (let i=0;i<weekdayOrder.length;i++){
                                if (dayStr.indexOf(weekdayOrder[i]) !== -1) return i;
                            }
                            // 文字が '土' のような短縮形
                            const shortMap = {'月':0,'火':1,'水':2,'木':3,'金':4,'土':5,'日':6};
                            for (const k in shortMap) if (dayStr.indexOf(k) !== -1) return shortMap[k];
                            return 999;
                        }
                        items.sort((a,b) => weekdayIndex(a[1]) - weekdayIndex(b[1]));
                        items.forEach(cells => {
                            const title = (cells[0] || '').toString().trim();
                            if (!title) return; // タイトルが空なら追加しない
                            const day = cells[1] || '';
                            const li = document.createElement('li');
                            li.textContent = `${title}\t${day}`;
                            li.style.padding = '6px 0';
                            li.style.fontSize = '1.05rem';
                            list.appendChild(li);
                        });
                    } catch(e) {
                        loading.textContent = 'ラジオ一覧の読み込みに失敗しました。';
                        console.error(e);
                    }
                }

                // 作品シートの描画（ジャンル別にグループ）
                function renderWorksData(data) {
                    const loading = document.getElementById('sheetLoadingWorks');
                    const list = document.getElementById('sheetWorksList');
                    try {
                        const rows = (data.table && data.table.rows) || [];
                        loading.style.display = 'none';
                        list.innerHTML = '';
                        const items = rows.map(r => r.c.map(c => c ? c.v : ''));
                        const groups = {};
                        items.forEach(cells => {
                            const title = (cells[0] || '').toString().trim();
                            if (!title) return; // 空タイトルは無視
                            const genre = (cells[1] || 'その他').toString();
                            if (!groups[genre]) groups[genre] = [];
                            groups[genre].push(title);
                        });
                        // 出力順: 映画, ドラマ, アニメ, その他
                        const order = ['映画','ドラマ','アニメ'];
                        order.forEach(g => {
                            if (groups[g]) {
                                const h = document.createElement('div');
                                h.style.fontWeight = '700';
                                h.style.marginTop = '6px';
                                h.textContent = g;
                                list.appendChild(h);
                                groups[g].forEach(t => {
                                    const li = document.createElement('li');
                                    li.textContent = t;
                                    li.style.padding = '6px 0 6px 8px';
                                    li.style.fontSize = '1.05rem';
                                    list.appendChild(li);
                                });
                                delete groups[g];
                            }
                        });
                        // その他残り
                        Object.keys(groups).forEach(g => {
                            const h = document.createElement('div');
                            h.style.fontWeight = '700';
                            h.style.marginTop = '6px';
                            h.textContent = g;
                            list.appendChild(h);
                            groups[g].forEach(t => {
                                const li = document.createElement('li');
                                li.textContent = t;
                                li.style.padding = '6px 0 6px 8px';
                                li.style.fontSize = '1.05rem';
                                list.appendChild(li);
                            });
                        });
                    } catch(e) {
                        loading.style.display = 'block';
                        loading.textContent = '作品一覧の読み込みに失敗しました。';
                        console.error(e);
                    }
                }

                // 両方のシートを取得して描画
                function refreshSheets() {
                    // ラジオシート
                    document.getElementById('sheetLoadingRadio').style.display = 'block';
                    fetchSheetByName('ラジオ', renderRadioData, (e)=>{
                        document.getElementById('sheetLoadingRadio').textContent = 'ラジオの読み込みに失敗しました。';
                    });
                    // 作品シート
                    document.getElementById('sheetLoadingWorks').style.display = 'block';
                    document.getElementById('sheetLoadingWorks').textContent = '読み込み中…';
                    fetchSheetByName('映画ドラマ', renderWorksData, (e)=>{
                        document.getElementById('sheetLoadingWorks').textContent = '作品の読み込みに失敗しました。';
                    });
                }

                // 初回取得と定期更新
                refreshSheets();
                setInterval(refreshSheets, 1000 * 60 * 3);
            </script>
                    <div id="sheetWorks" style="background:#fffbe7;border-radius:12px;padding:12px;box-shadow:0 4px 12px #66003322;">
                        <ul id="sheetWorksList" style="list-style:none;padding:0;margin:8px 0;display:flex;flex-direction:column;gap:6px;"></ul>
                    </div>
                </div>
            </div>

            
                <!-- Youtube player + playlist list restored -->
                <div style="max-width:900px;margin:20px auto;">
                    <h3 style="font-family:'Banana Slip'; color:#660033; text-align:center;">Youtube</h3>
                    <div id="youtubeContainer" style="background:#fffbe7;border-radius:12px;padding:12px;box-shadow:0 4px 12px #66003322;margin-bottom:14px;">
                        <div id="player" style="width:100%;height:360px;min-height:200px;background:#000;border-radius:8px;overflow:hidden;"></div>
                                                    <style>
                                                    /* Playlist responsive grid: cards shrink and wrap on small screens */
                                                    #playlistList{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;align-items:start;justify-items:center}
                                                    .playlist-item{width:100%;max-width:220px;box-sizing:border-box}
                                                    .playlist-item img{display:block;width:100%;height:auto;border-radius:8px}
                                                    #playlistControls button{font-family:'Banana Slip', sans-serif}
                                                    @media (max-width:420px){
                                                        #player{height:220px;min-height:140px}
                                                    }
                                                    </style>
                                                    <div id="playlistList">
                        <div id="playlistControls" style="text-align:center;margin:12px 0;"></div>
                    </div>
                </div>

            <script>
                const playlistId = 'PL_0HRbJsBYMbgkg4WlKMG0kvKIdbJQZYL';
                // 1) YouTube IFrame APIを読み込む
                let tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                document.body.appendChild(tag);

                let player;
                let idsGlobal = [];
                const BATCH_SIZE = 8; // 初回表示件数
                let renderedCount = 0;

                function onYouTubeIframeAPIReady() {
                    player = new YT.Player('player', {
                        height: '360',
                        width: '100%',
                        playerVars: {
                            listType: 'playlist',
                            list: playlistId,
                            modestbranding: 1,
                            rel: 0
                        },
                        events: {
                            'onReady': onPlayerReady
                        }
                    });
                }

                function onPlayerReady(event) {
                    // プレイヤーが準備できたら少し待ってからプレイリストIDを取得
                    setTimeout(buildPlaylistFromPlayer, 800);
                }

                function buildPlaylistFromPlayer(retries = 0) {
                    if (!player) return;
                    let ids = [];
                    try { ids = player.getPlaylist() || []; } catch(e) { ids = []; }
                    if (!ids || !ids.length) {
                        if (retries < 5) {
                            // 少し待って再試行
                            setTimeout(() => buildPlaylistFromPlayer(retries + 1), 600);
                            return;
                        }
                        const listEl = document.getElementById('playlistList');
                        listEl.innerHTML = '<div>プレイリスト情報を取得できませんでした。</div>';
                        return;
                    }
                    idsGlobal = ids;
                    renderedCount = 0;
                    document.getElementById('playlistList').innerHTML = '';
                    renderNextBatch();
                }

                function renderNextBatch() {
                    const listEl = document.getElementById('playlistList');
                    const slice = idsGlobal.slice(renderedCount, renderedCount + BATCH_SIZE);
                    slice.forEach((vid, idx) => {
                        const index = renderedCount + idx;
                        const item = document.createElement('div');
                        item.className = 'playlist-item';
                        item.style.cursor = 'pointer';
                        item.style.textAlign = 'center';

                        const a = document.createElement('a');
                        a.href = '#';
                        a.dataset.index = index;
                        a.style.textDecoration = 'none';
                        a.style.color = '#333';

                        const img = document.createElement('img');
                        img.loading = 'lazy';
                        img.src = `https://i.ytimg.com/vi/${vid}/hqdefault.jpg`;
                        img.alt = 'thumb';
                        img.style.width = '100%';
                        img.style.borderRadius = '8px';

                        const titleDiv = document.createElement('div');
                        titleDiv.textContent = vid;
                        titleDiv.style.fontSize = '0.9em';
                        titleDiv.style.marginTop = '6px';
                        titleDiv.style.color = '#660033';

                        a.appendChild(img);
                        a.appendChild(titleDiv);
                        a.addEventListener('click', (e) => {
                            e.preventDefault();
                            const idx = parseInt(a.dataset.index, 10);
                            if (player && typeof player.playVideoAt === 'function') {
                                player.playVideoAt(idx);
                            } else if (player && typeof player.cuePlaylist === 'function') {
                                player.cuePlaylist(idsGlobal, idx);
                            }
                        });

                        item.appendChild(a);
                        listEl.appendChild(item);

                        // タイトルをoEmbedで補完（非同期）
                        fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${vid}&format=json`)
                            .then(r => r.json())
                            .then(json => { titleDiv.textContent = json.title; })
                            .catch(() => { /* 失敗してもIDのまま */ });
                    });
                    renderedCount += slice.length;
                    updateLoadMoreButton();
                }

                function updateLoadMoreButton() {
                    const ctrl = document.getElementById('playlistControls');
                    ctrl.innerHTML = '';
                    if (renderedCount < idsGlobal.length) {
                        const btn = document.createElement('button');
                        btn.textContent = 'もっと見る';
                        btn.style.padding = '8px 16px';
                        btn.style.fontSize = '1em';
                        btn.style.fontFamily = "'Banana Slip', sans-serif";
                        btn.style.borderRadius = '8px';
                        btn.style.border = '2px solid #660033';
                        btn.style.background = '#e6f7ff';
                        btn.style.cursor = 'pointer';
                        btn.addEventListener('click', () => {
                            renderNextBatch();
                        });
                        ctrl.appendChild(btn);
                    } else {
                        // すべて表示済み
                    }
                }
            </script>
        </div>
    </div>
</body>
</html>
