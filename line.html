<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好きなエンタメ</title>
    <link rel="stylesheet" href="banana-slip.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #abced8;
            font-family: 'Rounded Mplus 1c', 'Arial', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .header {
            position: absolute;
            left: 50%;
            top: 15vh;
            transform: translateX(-50%);
            z-index: 10;
            font-family: 'Banana Slip', 'Rounded Mplus 1c', 'Arial', sans-serif;
            font-size: 4.5em;
            color: #660033;
            letter-spacing: 0.08em;
            text-shadow: 2px 2px 0 #fffbe7, 0 4px 12px #ffd70044;
            background: none;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            text-align: center;
            justify-content: center;
            align-items: center;
            display: flex;
        }
        @media (max-width: 600px) {
            .header { font-size: 3em; top: 7vh; justify-content:center; align-items:center; display:flex; }
            .main { padding: 0 2vw; text-align: center; }
            body { text-align: center !important; }
        }
        @media (max-width: 400px) {
            .header { font-size: 1em; top: 4vh; }
            .main { padding: 0 1vw; }
        }
        .main {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
        }
        .entame {
            margin-top: 32vh;
            width: 80vw;
            max-width: 800px;
            background: #fffbe7;
            border-radius: 18px;
            box-shadow: 0 4px 16px #66003322;
            padding: 32px;
        }
        .entame-title {
            font-family: 'Banana Slip', 'Rounded Mplus 1c', 'Arial', sans-serif;
            font-size: 2em;
            color: #660033;
            margin-bottom: 24px;
            text-align: center;
        }
        .entame-list {
            font-size: 1.1em;
            color: #333;
            line-height: 2;
        }
        .entame-list a {
            color: #660033;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="header">好きなエンタメ</div>
    <div class="main">
        <div class="entame">
            <div class="entame-title">おすすめエンタメ</div>
            <ul class="entame-list">
                <li><a href="https://www.tbsradio.jp/" target="_blank">TBSラジオ</a></li>
                <li><a href="https://www.youtube.com/" target="_blank">YouTube</a></li>
                <li><a href="https://www.netflix.com/jp/" target="_blank">Netflixドラマ</a></li>
            </ul>
            <div style="margin-top:32px;text-align:center;">
                <!-- プレイヤー（IFrame APIで制御） -->
                <div id="player" style="width:100%;max-width:900px;margin:0 auto;"></div>
                <!-- プレイリストのサムネ一覧 -->
                <div id="playlistList" style="margin-top:18px;display:flex;flex-wrap:wrap;gap:12px;justify-content:center;"></div>
                <div id="playlistControls" style="margin-top:12px;text-align:center;"></div>
            </div>
            <!-- Google スプレッドシートから読み込むお気に入りリスト -->
            <div style="margin-top:28px; max-width:900px; margin-left:auto; margin-right:auto;">
                <h3 style="font-family:'Banana Slip'; color:#660033; text-align:center;">たかはしのおすすめ（スプレッドシート連動）</h3>
                <div id="sheetList" style="background:#fffbe7;border-radius:12px;padding:16px;box-shadow:0 4px 12px #66003322;">
                    <div id="sheetLoading" style="text-align:center;color:#666;">読み込み中…</div>
                    <ul id="sheetItems" style="list-style:none;padding:0;margin:8px 0;display:flex;flex-direction:column;gap:10px;"></ul>
                </div>
            </div>

            <script>
                // Google スプレッドシートから一覧を取得して表示する (公開シート向け)
                const sheetId = '17DDnw6-GUBoSaaE9DOB8qWZcNkRuhfYN_L1m9cksUao';
                const sheetName = '';
                function fetchSheet() {
                    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json${sheetName?('&sheet='+encodeURIComponent(sheetName)):''}`;
                    fetch(url).then(r => r.text()).then(text => {
                        // Google のレスポンスは JSONP ライクなので先頭を取り除く
                        const jsonText = text.replace(/^\s*\/\*.*?\*\/\s*google\.visualization\.Query\.setResponse\(/, '').replace(/\);\s*$/, '');
                        const data = JSON.parse(jsonText);
                        renderSheetData(data);
                    }).catch(err => {
                        console.error('sheet fetch error', err);
                        document.getElementById('sheetLoading').textContent = 'スプレッドシートの読み込みに失敗しました。シートが公開されているか確認してください。';
                    });
                }

                function renderSheetData(data) {
                    const loading = document.getElementById('sheetLoading');
                    const list = document.getElementById('sheetItems');
                    try {
                        const table = data.table;
                        const cols = table.cols.map(c => c.label || c.id);
                        // 期待するカラム例: タイトル, 種類, リンク, メモ
                        const rows = table.rows || [];
                        loading.style.display = 'none';
                        list.innerHTML = '';
                        rows.forEach(r => {
                            const cells = r.c.map(c => c ? c.v : '');
                            // 1列目: タイトル, 2列目: 種類, 3列目: リンク
                            const title = cells[0] || '(タイトルなし)';
                            const type = cells[1] || '';
                            const link = cells[2] || '';
                            const note = cells[3] || '';

                            const li = document.createElement('li');
                            li.style.display = 'flex';
                            li.style.flexDirection = 'row';
                            li.style.alignItems = 'center';
                            li.style.gap = '12px';

                            const left = document.createElement('div');
                            left.style.flex = '0 0 10px';
                            left.style.width = '10px';
                            left.style.height = '10px';
                            left.style.borderRadius = '50%';
                            left.style.background = type === '映画' ? '#ff9800' : (type === 'ドラマ' ? '#4caf50' : '#2196f3');

                            const content = document.createElement('div');
                            content.style.flex = '1';
                            const titleEl = document.createElement('div');
                            titleEl.textContent = title + (type ? ` — ${type}` : '');
                            titleEl.style.fontWeight = '700';
                            titleEl.style.color = '#333';

                            if (link) {
                                const a = document.createElement('a');
                                a.href = link;
                                a.target = '_blank';
                                a.rel = 'noopener noreferrer';
                                a.style.color = '#660033';
                                a.style.textDecoration = 'underline';
                                a.textContent = '視聴/詳細';
                                titleEl.appendChild(document.createTextNode(' '));
                                titleEl.appendChild(a);
                            }
                            const noteEl = document.createElement('div');
                            noteEl.textContent = note;
                            noteEl.style.fontSize = '0.95em';
                            noteEl.style.color = '#666';

                            content.appendChild(titleEl);
                            if (note) content.appendChild(noteEl);

                            li.appendChild(left);
                            li.appendChild(content);
                            list.appendChild(li);
                        });
                    } catch (e) {
                        loading.textContent = 'スプレッドシートの形式を解析できませんでした。';
                        console.error(e);
                    }
                }

                // 実行
                fetchSheet();
                // 定期的に更新（例: 3分ごとに再取得）
                setInterval(fetchSheet, 1000 * 60 * 3);
            </script>
            <script>
                const playlistId = 'PL_0HRbJsBYMbgkg4WlKMG0kvKIdbJQZYL';
                // 1) YouTube IFrame APIを読み込む
                let tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                document.body.appendChild(tag);

                let player;
                let idsGlobal = [];
                const BATCH_SIZE = 8; // 初回表示件数
                let renderedCount = 0;

                function onYouTubeIframeAPIReady() {
                    player = new YT.Player('player', {
                        height: '360',
                        width: '100%',
                        playerVars: {
                            listType: 'playlist',
                            list: playlistId,
                            modestbranding: 1,
                            rel: 0
                        },
                        events: {
                            'onReady': onPlayerReady
                        }
                    });
                }

                function onPlayerReady(event) {
                    // プレイヤーが準備できたら少し待ってからプレイリストIDを取得
                    setTimeout(buildPlaylistFromPlayer, 800);
                }

                function buildPlaylistFromPlayer(retries = 0) {
                    if (!player) return;
                    let ids = [];
                    try { ids = player.getPlaylist() || []; } catch(e) { ids = []; }
                    if (!ids || !ids.length) {
                        if (retries < 5) {
                            // 少し待って再試行
                            setTimeout(() => buildPlaylistFromPlayer(retries + 1), 600);
                            return;
                        }
                        const listEl = document.getElementById('playlistList');
                        listEl.innerHTML = '<div>プレイリスト情報を取得できませんでした。</div>';
                        return;
                    }
                    idsGlobal = ids;
                    renderedCount = 0;
                    document.getElementById('playlistList').innerHTML = '';
                    renderNextBatch();
                }

                function renderNextBatch() {
                    const listEl = document.getElementById('playlistList');
                    const slice = idsGlobal.slice(renderedCount, renderedCount + BATCH_SIZE);
                    slice.forEach((vid, idx) => {
                        const index = renderedCount + idx;
                        const item = document.createElement('div');
                        item.className = 'playlist-item';
                        item.style.width = '160px';
                        item.style.cursor = 'pointer';
                        item.style.textAlign = 'center';

                        const a = document.createElement('a');
                        a.href = '#';
                        a.dataset.index = index;
                        a.style.textDecoration = 'none';
                        a.style.color = '#333';

                        const img = document.createElement('img');
                        img.loading = 'lazy';
                        img.src = `https://i.ytimg.com/vi/${vid}/hqdefault.jpg`;
                        img.alt = 'thumb';
                        img.style.width = '100%';
                        img.style.borderRadius = '8px';

                        const titleDiv = document.createElement('div');
                        titleDiv.textContent = vid;
                        titleDiv.style.fontSize = '0.9em';
                        titleDiv.style.marginTop = '6px';
                        titleDiv.style.color = '#660033';

                        a.appendChild(img);
                        a.appendChild(titleDiv);
                        a.addEventListener('click', (e) => {
                            e.preventDefault();
                            const idx = parseInt(a.dataset.index, 10);
                            if (player && typeof player.playVideoAt === 'function') {
                                player.playVideoAt(idx);
                            } else if (player && typeof player.cuePlaylist === 'function') {
                                player.cuePlaylist(idsGlobal, idx);
                            }
                        });

                        item.appendChild(a);
                        listEl.appendChild(item);

                        // タイトルをoEmbedで補完（非同期）
                        fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${vid}&format=json`)
                            .then(r => r.json())
                            .then(json => { titleDiv.textContent = json.title; })
                            .catch(() => { /* 失敗してもIDのまま */ });
                    });
                    renderedCount += slice.length;
                    updateLoadMoreButton();
                }

                function updateLoadMoreButton() {
                    const ctrl = document.getElementById('playlistControls');
                    ctrl.innerHTML = '';
                    if (renderedCount < idsGlobal.length) {
                        const btn = document.createElement('button');
                        btn.textContent = 'もっと見る';
                        btn.style.padding = '8px 16px';
                        btn.style.fontSize = '1em';
                        btn.style.borderRadius = '8px';
                        btn.style.border = '2px solid #660033';
                        btn.style.background = '#fffbe7';
                        btn.style.cursor = 'pointer';
                        btn.addEventListener('click', () => {
                            renderNextBatch();
                        });
                        ctrl.appendChild(btn);
                    } else {
                        // すべて表示済み
                    }
                }
            </script>
        </div>
    </div>
</body>
</html>
